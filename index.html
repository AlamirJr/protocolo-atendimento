<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Protocolo de Atendimento - SEDUCT</title>

  <style>
    :root{
      --bg: #f6f7fb;
      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --border: #e5e7eb;
      --shadow: 0 12px 30px rgba(17,24,39,.08);
      --shadow-sm: 0 6px 18px rgba(17,24,39,.08);
      --radius: 14px;

      --primary: #2563eb;
      --primary-2: #1d4ed8;

      --danger: #ef4444;
      --danger-2: #dc2626;

      --success: #16a34a;
      --success-bg: #dcfce7;

      --warn: #f59e0b;
      --warn-bg: #fffbeb;

      --pending-bg: #fee2e2;
      --pending: #991b1b;

      --attended-bg: #dcfce7;
      --attended: #166534;

      --focus: 0 0 0 4px rgba(37, 99, 235, .18);
    }

    * { box-sizing: border-box; }

    body{
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      background: radial-gradient(900px 500px at 20% -10%, rgba(37,99,235,.12), transparent 55%),
                  radial-gradient(900px 500px at 100% 0%, rgba(16,185,129,.10), transparent 50%),
                  var(--bg);
      color: var(--text);
    }

    /* =========================
       üîí TELA DE SENHA (LOCK)
       ========================= */
    #lock{
      position: fixed;
      inset: 0;
      z-index: 9999;
      display: grid;
      place-items: center;
      padding: 18px;
      background: radial-gradient(900px 500px at 20% -10%, rgba(37,99,235,.18), transparent 55%),
                  radial-gradient(900px 500px at 100% 0%, rgba(16,185,129,.14), transparent 50%),
                  #0b1220;
    }

    .lock-card{
      width: min(520px, 100%);
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(255,255,255,.55);
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,.25);
      padding: 18px;
      backdrop-filter: blur(10px);
    }

    .lock-title{
      margin: 0 0 6px;
      font-size: 18px;
      color: #111827;
      letter-spacing: .2px;
    }
    .lock-subtitle{
      margin: 0 0 14px;
      color: #374151;
      font-size: 13px;
      line-height: 1.45;
    }

    .lock-row{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
    }

    .lock-input{
      flex: 1 1 220px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #fff;
      font-size: 14px;
      outline: none;
    }
    .lock-input:focus{
      border-color: rgba(37,99,235,.55);
      box-shadow: var(--focus);
    }

    .lock-btn{
      appearance:none;
      border: 1px solid transparent;
      background: linear-gradient(180deg, var(--primary), var(--primary-2));
      color: #fff;
      padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 800;
      font-size: 13px;
      box-shadow: 0 10px 22px rgba(37,99,235,.25);
      white-space: nowrap;
    }
    .lock-btn:hover{ filter: brightness(1.05); }
    .lock-hint{
      margin: 10px 0 0;
      color: rgba(17,24,39,.70);
      font-size: 12px;
    }

    /* o app fica escondido at√© destravar */
    #app{ display:none; }

    /* =========================
       (SEU CSS ORIGINAL CONTINUA)
       ========================= */

    .app{
      max-width: 1200px;
      margin: 22px auto;
      padding: 0 16px 28px;
    }

    /* Topbar */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 16px;
      padding: 14px 16px;
      background: rgba(255,255,255,.75);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 10px;
      z-index: 5;
    }

    .brand{
      display:flex;
      gap: 12px;
      align-items:center;
      min-width: 240px;
    }
    .logo{
      width: 38px; height: 38px;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--primary), #22c55e);
      box-shadow: 0 10px 20px rgba(37,99,235,.22);
      position: relative;
      flex: 0 0 auto;
    }
    .logo::after{
      content:"";
      position:absolute;
      inset: 9px;
      border-radius: 10px;
      background: rgba(255,255,255,.65);
    }
    .brand h1{
      margin:0;
      font-size: 16px;
      line-height: 1.2;
      letter-spacing: .2px;
    }
    .brand p{
      margin:2px 0 0;
      font-size: 12px;
      color: var(--muted);
    }

    .top-actions{
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: flex-end;
      align-items:center;
    }

    /* Buttons */
    .btn{
      appearance:none;
      border:1px solid var(--border);
      background: var(--card);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 600;
      font-size: 13px;
      display:inline-flex;
      align-items:center;
      gap: 10px;
      transition: transform .04s ease, box-shadow .18s ease, background .18s ease, border-color .18s ease;
      box-shadow: 0 8px 18px rgba(17,24,39,.06);
      user-select:none;
    }
    .btn:hover{
      transform: translateY(-1px);
      box-shadow: 0 12px 24px rgba(17,24,39,.10);
      border-color: #d1d5db;
    }
    .btn:active{ transform: translateY(0); box-shadow: 0 8px 18px rgba(17,24,39,.06); }
    .btn:focus{ outline:none; box-shadow: var(--focus), 0 12px 24px rgba(17,24,39,.12); }

    .btn-primary{
      border-color: rgba(37,99,235,.30);
      background: linear-gradient(180deg, rgba(37,99,235,.12), rgba(37,99,235,.06));
      color: #0b2a7a;
    }
    .btn-primary:hover{
      border-color: rgba(37,99,235,.45);
      background: linear-gradient(180deg, rgba(37,99,235,.16), rgba(37,99,235,.08));
    }

    .btn-solid{
      border-color: transparent;
      background: linear-gradient(180deg, var(--primary), var(--primary-2));
      color: white;
    }
    .btn-solid:hover{
      background: linear-gradient(180deg, #3b82f6, var(--primary-2));
    }

    .btn-danger{
      border-color: transparent;
      background: linear-gradient(180deg, var(--danger), var(--danger-2));
      color: #fff;
    }
    .btn-danger:hover{
      background: linear-gradient(180deg, #f87171, var(--danger-2));
    }

    .icon{
      width: 18px; height: 18px;
      display:inline-block;
    }

    /* Layout grid */
    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 16px;
      margin-top: 16px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .brand{ min-width: unset; }
      .topbar{ align-items:flex-start; }
    }

    /* Cards */
    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .card-header{
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 10px;
      background: linear-gradient(180deg, rgba(17,24,39,.02), transparent);
    }
    .card-header h2{
      margin:0;
      font-size: 14px;
      letter-spacing:.2px;
    }
    .card-header .hint{
      margin:0;
      font-size: 12px;
      color: var(--muted);
    }
    .card-body{
      padding: 16px;
    }

    /* Form */
    form{ margin:0; }

    .form-grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 12px;
    }

    .field{ display:flex; flex-direction: column; gap: 6px; }
    .field label{
      font-size: 12px;
      color: #374151;
      font-weight: 700;
    }

    input, textarea, select{
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #ffffff;
      color: var(--text);
      font-size: 14px;
      transition: box-shadow .15s ease, border-color .15s ease;
    }
    textarea{ resize: vertical; min-height: 92px; }
    input:focus, textarea:focus, select:focus{
      outline:none;
      border-color: rgba(37,99,235,.55);
      box-shadow: var(--focus);
    }
    .muted{ color: var(--muted); font-size: 12px; margin: 0; }

    /* Column spans */
    .col-12{ grid-column: span 12; }
    .col-8{ grid-column: span 8; }
    .col-6{ grid-column: span 6; }
    .col-4{ grid-column: span 4; }
    .col-3{ grid-column: span 3; }

    @media (max-width: 720px){
      .col-8,.col-6,.col-4,.col-3{ grid-column: span 12; }
    }

    .form-actions{
      margin-top: 14px;
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .form-actions .btn{ flex: 1 1 180px; justify-content:center; }

    /* Notice */
    .aviso{
      background: var(--warn-bg);
      border: 1px solid rgba(245, 158, 11, .35);
      padding: 12px 12px;
      border-radius: 12px;
      margin: 12px 0 0;
      font-size: 13px;
      line-height: 1.35;
      color: #78350f;
    }

    /* Table */
    .table-wrap{
      overflow:auto;
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }
    table{
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      min-width: 980px;
      background: #fff;
    }
    thead th{
      position: sticky;
      top: 0;
      z-index: 2;
      background: #f9fafb;
      color: #374151;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .06em;
      border-bottom: 1px solid var(--border);
      padding: 12px 10px;
      text-align: left;
      white-space: nowrap;
    }
    tbody td{
      border-bottom: 1px solid var(--border);
      padding: 10px 10px;
      vertical-align: top;
      font-size: 13px;
      color: #111827;
      word-break: break-word;
    }
    tbody tr:hover td{
      background: rgba(37,99,235,.04);
    }

    /* Status badge */
    .badge{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 800;
      font-size: 12px;
      border: 1px solid transparent;
      white-space: nowrap;
    }
    .badge::before{
      content:"";
      width: 8px; height: 8px;
      border-radius: 999px;
      background: currentColor;
      opacity: .75;
    }

    /* ‚úÖ Status coloridos (novos) */
    .badge-pendente{
      background: var(--pending-bg);
      color: var(--pending);
      border-color: rgba(153, 27, 27, .18);
    }
    .badge-andamento{
      background: var(--warn-bg);
      color: #92400e;
      border-color: rgba(245, 158, 11, .35);
    }
    .badge-concluido{
      background: var(--attended-bg);
      color: var(--attended);
      border-color: rgba(22, 101, 52, .20);
    }
    .badge-cancelado{
      background: #f3f4f6;
      color: #374151;
      border-color: rgba(107, 114, 128, .25);
    }

    /* Inline action button */
    .acoes-btn{
      width: auto;
      padding: 8px 10px;
      font-size: 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #fff;
      cursor:pointer;
      font-weight: 700;
      transition: box-shadow .15s ease, transform .05s ease, background .15s ease;
    }
    .acoes-btn:hover{ box-shadow: 0 10px 18px rgba(17,24,39,.08); transform: translateY(-1px); }
    .acoes-btn:active{ transform: translateY(0); }
    .acoes-btn:focus{ outline:none; box-shadow: var(--focus), 0 10px 18px rgba(17,24,39,.10); }

    /* Small helper line */
    .subline{
      display:flex;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 6px;
    }

    /* ===========================================================
       ‚úÖ NOVO: ferramentas de filtro na tabela (pesquisa + contador)
       =========================================================== */
    .table-tools{
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content: space-between;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .search{
      flex: 1 1 320px;
      display:flex;
      gap: 10px;
      align-items:center;
    }

    .search input{
      flex: 1 1 auto;
    }

    .counter{
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
    }
  </style>
</head>

<body>

  <!-- üîí BLOQUEIO -->
  <div id="lock" role="dialog" aria-modal="true" aria-labelledby="lock-title">
    <div class="lock-card">
      <h2 class="lock-title" id="lock-title">Acesso restrito</h2>
      <p class="lock-subtitle">Digite a senha para acessar o Protocolo de Atendimento.</p>

      <form id="lock-form" autocomplete="off">
        <div class="lock-row">
          <input class="lock-input" id="lock-pass" type="password" placeholder="Senha" aria-label="Senha" />
          <button class="lock-btn" type="submit">Entrar</button>
        </div>
        <p class="lock-hint">Obs.: prote√ß√£o local (HTML est√°tico). Para seguran√ßa real, use autentica√ß√£o no servidor.</p>
      </form>
    </div>
  </div>

  <!-- ‚úÖ APP (fica oculto at√© destravar) -->
  <div class="app" id="app">

    <header class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Protocolo de Atendimento</h1>
          <p>Educa√ß√£o Inclusiva ‚Ä¢ Registro e Controle de Solicita√ß√µes</p>
        </div>
      </div>

      <div class="top-actions">
        <button class="btn btn-primary" id="escolher-arquivo" type="button" title="Escolher arquivo Excel (uma vez)">
          <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M12 3v10m0 0 4-4m-4 4-4-4M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Escolher Excel
        </button>

        <button class="btn btn-solid" id="salvar-dados" type="button" title="Salvar no mesmo Excel (sobrescrever)">
          <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M19 21H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h11l5 5v9a2 2 0 0 1-2 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M17 21v-8H7v8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M7 3v4h8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Salvar Excel
        </button>

        <button class="btn btn-primary" id="carregar-dados" type="button" title="Carregar Atendimento (Excel)">
          <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M12 21V11m0 0 4 4m-4-4-4 4M5 7V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Importar Excel
        </button>

        <!-- ‚úÖ BOT√ÉO: copiar resumo de pend√™ncias -->
        <button class="btn btn-primary" id="copiar-resumo" type="button" title="Copiar resumo de pend√™ncias por PSP">
          <svg class="icon" viewBox="0 0 24 24" fill="none">
            <path d="M8 7h11a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M16 7V5a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Copiar pend√™ncias
        </button>

        <button class="btn btn-danger" id="limpar-dados" type="button" title="Limpar Atendimentos">
          <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M3 6h18M8 6V4h8v2m-1 0v16a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2V6h10Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Limpar
        </button>
      </div>
    </header>

    <div class="grid">
      <!-- FORM -->
      <section class="card">
        <div class="card-header">
          <div>
            <h2>Novo atendimento</h2>
            <p class="hint">Preencha os dados e registre. O status pode ser alterado na tabela.</p>
          </div>
        </div>

        <div class="card-body">
          <form id="form-atendimento">
            <div class="form-grid">
              <div class="field col-6">
                <label for="atendimento">Atendimento</label>
                <input type="text" id="atendimento" placeholder="Ex.: Solicita√ß√£o de mediador" required />
              </div>

              <div class="field col-6">
                <label for="telefone">Telefone</label>
                <input type="text" id="telefone" placeholder="(22) 9xxxx-xxxx" required inputmode="tel" />
              </div>

              <div class="field col-4">
                <label for="vinculo">V√≠nculo com a escola</label>
                <select id="vinculo" required>
                  <option value="">Selecione</option>
                  <option value="Diretor">Diretor</option>
                  <option value="Diretor Adjunto">Diretor Adjunto</option>
                  <option value="M√£e">M√£e</option>
                  <option value="Outros">Outros</option>
                </select>
              </div>

              <div class="field col-8">
                <label for="aluno">Aluno</label>
                <input type="text" id="aluno" placeholder="Nome do aluno" required />
              </div>

              <div class="field col-3">
                <label for="idade">Idade</label>
                <input type="number" id="idade" required min="0" placeholder="0" />
              </div>

              <div class="field col-3">
                <label for="ae">AE</label>
                <input type="text" id="ae" required placeholder="Escola / AE" />
              </div>

              <div class="field col-3">
                <label for="turno">Turno</label>
                <input type="text" id="turno" required placeholder="Manh√£ / Tarde" />
              </div>

              <div class="field col-3">
                <label for="psp">PSP respons√°vel</label>
                <input type="text" id="psp" required placeholder="Nome do PSP" />
              </div>

              <div class="field col-12">
                <label for="solicitacao">Descri√ß√£o da solicita√ß√£o</label>
                <textarea id="solicitacao" required rows="3" placeholder="Descreva o pedido de forma objetiva..."></textarea>
                <div class="subline">
                  <p class="muted">Dica: informe contexto e urg√™ncia (se houver).</p>
                  <p class="muted">Campos com * s√£o obrigat√≥rios (valida√ß√£o pelo navegador).</p>
                </div>
              </div>

              <div class="field col-6">
                <label for="tipo">Tipo de solicita√ß√£o</label>
                <select id="tipo" required>
                  <option value="">Selecione</option>
                  <option value="Pedido de Mediador">Pedido de Mediador</option>
                  <option value="Pedido de Cuidador">Pedido de Cuidador</option>
                </select>
              </div>

              <div class="field col-6">
                <label for="status">Status do atendimento</label>
                <!-- ‚úÖ ampliado p/ bater com planilha -->
                <select id="status" required>
                  <option value="Pendente">Pendente</option>
                  <option value="Em andamento">Em andamento</option>
                  <option value="Conclu√≠do">Conclu√≠do</option>
                  <option value="Cancelado">Cancelado</option>
                </select>
              </div>
            </div>

            <div class="form-actions">
              <button class="btn btn-solid" type="submit" style="flex: 1 1 240px; justify-content:center;">
                <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M12 5v14m-7-7h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                Registrar atendimento
              </button>
            </div>

            <div class="aviso" id="aviso-api" style="display:none;">
              Seu navegador n√£o suporta sobrescrever o mesmo Excel automaticamente.
              Use Chrome/Edge no computador para habilitar ‚ÄúSalvar no mesmo arquivo‚Äù.
            </div>
          </form>
        </div>
      </section>

      <!-- INFO CARD -->
      <aside class="card">
        <div class="card-header">
          <div>
            <h2>Opera√ß√£o</h2>
            <p class="hint">Atalhos e boas pr√°ticas</p>
          </div>
        </div>
        <div class="card-body">
          <ul style="margin:0; padding-left: 18px; color: var(--muted); font-size: 13px; line-height: 1.55;">
            <li>Use <b>Escolher Excel</b> uma √∫nica vez; depois, <b>Salvar Excel</b> sobrescreve o mesmo arquivo.</li>
            <li>Para consulta r√°pida, a tabela √© ordenada por <b>PSP</b> (exibi√ß√£o).</li>
            <li>Para alterar situa√ß√£o, clique em <b>Alterar status</b> na linha.</li>
            <li><b>Novo:</b> use <b>Copiar pend√™ncias</b> para gerar um resumo por PSP e colar no WhatsApp/e-mail.</li>
            <li><b>Novo:</b> use o campo <b>Filtrar</b> acima da tabela para achar qualquer registro r√°pido.</li>
            <li>Se ficar lento com muitos registros, prefira trabalhar por per√≠odos e exportar.</li>
          </ul>
        </div>
      </aside>
    </div>

    <!-- TABLE -->
    <section class="card" style="margin-top:16px;">
      <div class="card-header">
        <div>
          <h2>Atendimentos registrados</h2>
          <p class="hint">Rolagem horizontal dispon√≠vel (muitos campos).</p>
        </div>
      </div>

      <div class="card-body">
        <div class="table-tools">
          <div class="search">
            <input id="filtro-tabela" type="text" placeholder="Filtrar por aluno, AE, PSP, telefone, tipo, status..." />
            <button class="btn btn-primary" id="limpar-filtro" type="button">Limpar filtro</button>
          </div>
          <div class="counter" id="contador-tabela">0 de 0</div>
        </div>

        <div class="table-wrap">
          <table id="tabela-atendimentos">
            <thead>
              <tr>
                <th>Data/Hora</th>
                <th>Atendimento</th>
                <th>Telefone</th>
                <th>V√≠nculo</th>
                <th>Aluno</th>
                <th>Idade</th>
                <th>AE</th>
                <th>Turno</th>
                <th>PSP Respons√°vel</th>
                <th>Solicita√ß√£o</th>
                <th>Tipo</th>
                <th>Status</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

  </div>

  <!-- ‚úÖ Script do LOCK (vem antes do resto) -->
  <script>
    (function(){
      const PASSWORD = "1234"; // <<< TROQUE AQUI
      const lock = document.getElementById("lock");
      const app  = document.getElementById("app");
      const form = document.getElementById("lock-form");
      const input = document.getElementById("lock-pass");

      function unlock(){
        lock.style.display = "none";
        app.style.display = "block";
      }

      form.addEventListener("submit", function(ev){
        ev.preventDefault();
        const value = (input.value || "").trim();
        if(value === PASSWORD){
          try { sessionStorage.setItem("protocolo_unlock", "1"); } catch(e) {}
          unlock();
        }else{
          input.value = "";
          input.focus();
          alert("Senha incorreta.");
        }
      });

      // mant√©m destravado s√≥ nesta aba (at√© fechar)
      try{
        if(sessionStorage.getItem("protocolo_unlock") === "1"){
          unlock();
        }else{
          input.focus();
        }
      }catch(e){
        input.focus();
      }
    })();
  </script>

  <!-- SheetJS (XLSX) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    const STORAGE_KEY = "atendimentos";
    let excelFileHandle = null;

    function gerarId() {
      if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
      return "id-" + Date.now() + "-" + Math.random().toString(16).slice(2);
    }

    function getAtendimentos() {
      return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    }

    function setAtendimentos(lista) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(lista));
    }

    function suportaSobrescreverExcel() {
      return !!window.showSaveFilePicker;
    }

    function mostrarAvisoSeNaoSuporta() {
      const aviso = document.getElementById("aviso-api");
      if (!suportaSobrescreverExcel()) {
        aviso.style.display = "block";
        document.getElementById("escolher-arquivo").disabled = true;
        document.getElementById("salvar-dados").disabled = true;
      }
    }

    document.getElementById("form-atendimento").addEventListener("submit", function (e) {
      e.preventDefault();

      const atendimento = {
        id: gerarId(),
        dataHora: new Date().toLocaleString(),
        atendimento: document.getElementById("atendimento").value.trim(),
        telefone: document.getElementById("telefone").value.trim(),
        vinculo: document.getElementById("vinculo").value,
        aluno: document.getElementById("aluno").value.trim(),
        idade: document.getElementById("idade").value,
        ae: document.getElementById("ae").value.trim(),
        turno: document.getElementById("turno").value.trim(),
        psp: document.getElementById("psp").value.trim(),
        solicitacao: document.getElementById("solicitacao").value.trim(),
        tipo: document.getElementById("tipo").value,
        status: document.getElementById("status").value
      };

      const atendimentos = getAtendimentos();
      atendimentos.push(atendimento);
      setAtendimentos(atendimentos);

      listarAtendimentos();
      e.target.reset();
    });

    function statusToBadge(statusRaw){
      const s = (statusRaw || "Pendente").toString().trim().toLowerCase();

      if (s === "conclu√≠do" || s === "concluido" || s === "atendido") {
        return { cls: "badge-concluido", label: "Conclu√≠do" };
      }
      if (s === "em andamento" || s === "andamento") {
        return { cls: "badge-andamento", label: "Em andamento" };
      }
      if (s === "cancelado" || s === "cancelada") {
        return { cls: "badge-cancelado", label: "Cancelado" };
      }
      return { cls: "badge-pendente", label: "Pendente" };
    }

    function listarAtendimentos() {
      const tbody = document.querySelector("#tabela-atendimentos tbody");
      tbody.innerHTML = "";

      const filtroEl = document.getElementById("filtro-tabela");
      const contadorEl = document.getElementById("contador-tabela");

      const filtro = (filtroEl?.value || "").trim().toLowerCase();

      const atendimentosAll = getAtendimentos().slice();
      atendimentosAll.sort((a, b) => (a.psp || "").localeCompare(b.psp || ""));

      const atendimentos = !filtro
        ? atendimentosAll
        : atendimentosAll.filter(a => {
            const blob = [
              a.dataHora, a.atendimento, a.telefone, a.vinculo, a.aluno, a.idade,
              a.ae, a.turno, a.psp, a.solicitacao, a.tipo, a.status
            ].join(" ").toLowerCase();
            return blob.includes(filtro);
          });

      if (contadorEl) contadorEl.textContent = `${atendimentos.length} de ${atendimentosAll.length}`;

      atendimentos.forEach((a) => {
        const row = document.createElement("tr");

        const cells = [
          a.dataHora,
          a.atendimento,
          a.telefone,
          a.vinculo,
          a.aluno,
          a.idade,
          a.ae,
          a.turno,
          a.psp,
          a.solicitacao,
          a.tipo
        ];

        cells.forEach((val) => {
          const td = document.createElement("td");
          td.textContent = val ?? "";
          row.appendChild(td);
        });

        const tdStatus = document.createElement("td");
        const badge = document.createElement("span");
        const b = statusToBadge(a.status);
        badge.className = "badge " + b.cls;
        badge.textContent = b.label;
        tdStatus.appendChild(badge);
        row.appendChild(tdStatus);

        const tdAcoes = document.createElement("td");
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "acoes-btn";
        btn.textContent = "Alterar status";
        btn.addEventListener("click", () => editarStatus(a.id));
        tdAcoes.appendChild(btn);
        row.appendChild(tdAcoes);

        tbody.appendChild(row);
      });
    }

    /* ‚úÖ alterna entre os 4 status */
    function editarStatus(id) {
      const atendimentos = getAtendimentos();
      const i = atendimentos.findIndex(x => x.id === id);
      if (i === -1) return;

      const ordem = ["Pendente", "Em andamento", "Conclu√≠do", "Cancelado"];
      const atual = (atendimentos[i].status || "Pendente").toString();
      const idx = ordem.findIndex(s => s.toLowerCase() === atual.toLowerCase());
      atendimentos[i].status = ordem[(idx + 1 + ordem.length) % ordem.length];

      setAtendimentos(atendimentos);
      listarAtendimentos();
    }

    document.getElementById("limpar-dados").addEventListener("click", () => {
      if (confirm("Deseja apagar todos os atendimentos?")) {
        localStorage.removeItem(STORAGE_KEY);
        listarAtendimentos();
      }
    });

    document.getElementById("escolher-arquivo").addEventListener("click", async () => {
      try {
        excelFileHandle = await window.showSaveFilePicker({
          suggestedName: "atendimentos.xlsx",
          types: [{
            description: "Arquivo Excel",
            accept: {
              "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet": [".xlsx"]
            }
          }]
        });
        alert("Arquivo selecionado. A partir de agora ele ser√° sobrescrito ao salvar.");
      } catch {
        alert("Nenhum arquivo foi selecionado.");
      }
    });

    /* ‚úÖ EXPORT: cabe√ßalhos iguais aos da SUA PLANILHA */
    function montarWorkbookAtendimentos(atendimentos) {
      const exportRows = atendimentos.map(a => ({
        "ID": a.id,
        "Data/Hora": a.dataHora,
        "Atendimento": a.atendimento,
        "Telefone": a.telefone,
        "V√≠nculo com a escola": a.vinculo,
        "Aluno": a.aluno,
        "Idade": a.idade,
        "AE": a.ae,
        "Turno": a.turno,
        "PSP respons√°vel": a.psp,
        "Descri√ß√£o da solicita√ß√£o": a.solicitacao,
        "Tipo de solicita√ß√£o": a.tipo,
        "Status do atendimento": a.status
      }));

      const ws = XLSX.utils.json_to_sheet(exportRows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Atendimentos");
      return wb;
    }

    document.getElementById("salvar-dados").addEventListener("click", async () => {
      const atendimentos = getAtendimentos();

      if (atendimentos.length === 0) {
        alert("N√£o h√° atendimentos para salvar.");
        return;
      }

      if (!excelFileHandle) {
        alert("Clique primeiro em 'Escolher Excel'.");
        return;
      }

      try {
        const wb = montarWorkbookAtendimentos(atendimentos);
        const buffer = XLSX.write(wb, { bookType: "xlsx", type: "array" });

        const writable = await excelFileHandle.createWritable();
        await writable.write(buffer);
        await writable.close();

        alert("Excel atualizado (sobrescrito) com sucesso.");
      } catch (err) {
        alert("Falha ao sobrescrever o arquivo. Tente escolher o arquivo novamente.");
      }
    });

    document.getElementById("carregar-dados").addEventListener("click", () => {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = ".xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";

      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        try {
          const data = await file.arrayBuffer();
          const wb = XLSX.read(data, { type: "array" });
          const ws = wb.Sheets[wb.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(ws, { defval: "" });

          if (!Array.isArray(rows)) throw new Error("Formato inv√°lido.");

          /* ‚úÖ IMPORT: aceita nomes antigos E os nomes reais da planilha */
          const normalizados = rows.map(r => ({
            id: (r["ID"] || r["Id"] || r["id"] || gerarId()).toString(),
            dataHora: (r["Data/Hora"] || r["dataHora"] || r["DataHora"] || new Date().toLocaleString()).toString(),
            atendimento: (r["Atendimento"] || r["atendimento"] || "").toString(),
            telefone: (r["Telefone"] || r["telefone"] || "").toString(),

            vinculo: (r["V√≠nculo com a escola"] || r["V√≠nculo"] || r["Vinculo"] || r["vinculo"] || "").toString(),

            aluno: (r["Aluno"] || r["aluno"] || "").toString(),
            idade: (r["Idade"] || r["idade"] || "").toString(),
            ae: (r["AE"] || r["ae"] || "").toString(),
            turno: (r["Turno"] || r["turno"] || "").toString(),

            psp: (r["PSP respons√°vel"] || r["PSP Respons√°vel"] || r["PSP Responsavel"] || r["psp"] || "").toString(),

            solicitacao: (r["Descri√ß√£o da solicita√ß√£o"] || r["Solicita√ß√£o"] || r["Solicitacao"] || r["solicitacao"] || "").toString(),

            tipo: (r["Tipo de solicita√ß√£o"] || r["Tipo"] || r["tipo"] || "").toString(),

            status: (r["Status do atendimento"] || r["Status"] || r["status"] || "Pendente").toString()
          }));

          setAtendimentos(normalizados);
          listarAtendimentos();
          alert("Atendimentos importados com sucesso!");
        } catch (err) {
          alert("Arquivo inv√°lido ou corrompido. N√£o foi poss√≠vel importar.");
        }
      };

      input.click();
    });

    async function copiarResumoPendenciasPorPSP() {
      const atendimentos = getAtendimentos();
      const pendentes = atendimentos.filter(a => {
        const s = (a.status || "Pendente").toString().toLowerCase();
        return !(s === "conclu√≠do" || s === "concluido" || s === "atendido");
      });

      if (pendentes.length === 0) {
        alert("N√£o h√° pend√™ncias.");
        return;
      }

      const grupos = new Map();
      for (const a of pendentes) {
        const psp = (a.psp || "Sem PSP").trim() || "Sem PSP";
        if (!grupos.has(psp)) grupos.set(psp, []);
        grupos.get(psp).push(a);
      }

      const pspsOrdenados = Array.from(grupos.keys()).sort((x, y) => x.localeCompare(y));

      const linhas = [];
      linhas.push(`üìå Resumo de pend√™ncias (total: ${pendentes.length})`);
      linhas.push(`Gerado em: ${new Date().toLocaleString()}`);
      linhas.push("");

      for (const psp of pspsOrdenados) {
        const itens = grupos.get(psp);
        linhas.push(`üë§ ${psp}: ${itens.length} pend√™ncia(s)`);

        itens.slice(0, 10).forEach((a, idx) => {
          linhas.push(`  ${idx + 1}. ${a.aluno || "-"} ‚Ä¢ ${a.tipo || "-"} ‚Ä¢ AE: ${a.ae || "-"}`);
        });

        if (itens.length > 10) {
          linhas.push(`  ‚Ä¶ +${itens.length - 10} item(ns)`);
        }

        linhas.push("");
      }

      const texto = linhas.join("\n");

      try {
        await navigator.clipboard.writeText(texto);
        alert("Resumo copiado para a √°rea de transfer√™ncia!");
      } catch (e) {
        prompt("Seu navegador bloqueou o copiar autom√°tico. Copie manualmente:", texto);
      }
    }

    document.getElementById("copiar-resumo").addEventListener("click", copiarResumoPendenciasPorPSP);

    document.getElementById("filtro-tabela").addEventListener("input", listarAtendimentos);

    document.getElementById("limpar-filtro").addEventListener("click", () => {
      const el = document.getElementById("filtro-tabela");
      el.value = "";
      el.focus();
      listarAtendimentos();
    });

    window.onload = () => {
      mostrarAvisoSeNaoSuporta();
      listarAtendimentos();
    };
  </script>
</body>
</html>
